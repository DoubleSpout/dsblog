<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="mongodb单机可靠性比较低，我们投入生产环境往往需要多台服务器的容灾和负载均衡，mongodb推荐使用Replica Sets来进行小的容灾和负载解决方案。我相信很多中小型互联网公司3-4台mongodb服务器的配置无论从抗压和稳定角度来说都已经足够了，至少数据量在千万级以下都不需要考虑sharding分片和cluster集群。 我们公司最近将mongodb投入生产，本文将对架设，模拟灾难（包">
<meta name="keywords" content="mongodb">
<meta property="og:type" content="article">
<meta property="og:title" content="Mongodb Replica Sets 副本集架构实战(架设、扩充、容灾、修复、客户端代码连入)">
<meta property="og:url" content="http://yoursite.com/2012/05/16/js-ajax/index.html">
<meta property="og:site_name" content="snoopyxdy的博客">
<meta property="og:description" content="mongodb单机可靠性比较低，我们投入生产环境往往需要多台服务器的容灾和负载均衡，mongodb推荐使用Replica Sets来进行小的容灾和负载解决方案。我相信很多中小型互联网公司3-4台mongodb服务器的配置无论从抗压和稳定角度来说都已经足够了，至少数据量在千万级以下都不需要考虑sharding分片和cluster集群。 我们公司最近将mongodb投入生产，本文将对架设，模拟灾难（包">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/img/mgo/m1.gif">
<meta property="og:image" content="http://yoursite.com/img/mgo/m2.gif">
<meta property="og:image" content="http://yoursite.com/img/mgo/m3.gif">
<meta property="og:image" content="http://yoursite.com/img/mgo/m4.gif">
<meta property="og:image" content="http://yoursite.com/img/mgo/m5.gif">
<meta property="og:image" content="http://yoursite.com/img/mgo/m6.gif">
<meta property="og:updated_time" content="2018-11-26T03:48:18.848Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mongodb Replica Sets 副本集架构实战(架设、扩充、容灾、修复、客户端代码连入)">
<meta name="twitter:description" content="mongodb单机可靠性比较低，我们投入生产环境往往需要多台服务器的容灾和负载均衡，mongodb推荐使用Replica Sets来进行小的容灾和负载解决方案。我相信很多中小型互联网公司3-4台mongodb服务器的配置无论从抗压和稳定角度来说都已经足够了，至少数据量在千万级以下都不需要考虑sharding分片和cluster集群。 我们公司最近将mongodb投入生产，本文将对架设，模拟灾难（包">
<meta name="twitter:image" content="http://yoursite.com/img/mgo/m1.gif">






  <link rel="canonical" href="http://yoursite.com/2012/05/16/js-ajax/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Mongodb Replica Sets 副本集架构实战(架设、扩充、容灾、修复、客户端代码连入) | snoopyxdy的博客</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">snoopyxdy的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">不要用执行上的勤奋来掩盖思考上的懒惰</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2012/05/16/js-ajax/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="snoopyxdy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="snoopyxdy的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Mongodb Replica Sets 副本集架构实战(架设、扩充、容灾、修复、客户端代码连入)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2012-05-16 16:50:21" itemprop="dateCreated datePublished" datetime="2012-05-16T16:50:21+08:00">2012-05-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-26 11:48:18" itemprop="dateModified" datetime="2018-11-26T11:48:18+08:00">2018-11-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/mongodb/" itemprop="url" rel="index"><span itemprop="name">mongodb</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2012/05/16/js-ajax/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count gitment-comments-count" data-xid="/2012/05/16/js-ajax/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>mongodb单机可靠性比较低，我们投入生产环境往往需要多台服务器的容灾和负载均衡，mongodb推荐使用Replica Sets来进行小的容灾和负载解决方案。我相信很多中小型互联网公司3-4台mongodb服务器的配置无论从抗压和稳定角度来说都已经足够了，至少数据量在千万级以下都不需要考虑sharding分片和cluster集群。</p>
<p>我们公司最近将mongodb投入生产，本文将对架设，模拟灾难（包括断电,断网,数据损坏），修复和客户端(node.js)连接mongodb副本集做一个比较详细的分享，如有错误，欢迎指出，板砖轻拍啊。</p>
<a id="more"></a>
<p>[参考资料]</p>
<p>参考：mongodb 官方API <a href="http://www.mongodb.org/display/DOCS/Replica+Sets" target="_blank" rel="noopener">http://www.mongodb.org/display/DOCS/Replica+Sets</a></p>
<p>参考：Kristina Chodorow’s 博客(mongodb开发程序员的博客) <a href="http://www.snailinaturtleneck.com/blog/2012/05/07/replica-set-internals-bootcamp-part-iv-syncing/" target="_blank" rel="noopener">http://www.snailinaturtleneck.com/blog/2012/05/07/replica-set-internals-bootcamp-part-iv-syncing/</a></p>
<p>参考：Kristina 写的3本mongodb书籍 《MongoDB 权威指南》、《Scaling MongoDB》和《50 Tips and Tricks for MongoDB Developers》</p>
<p>参考：noSqlFan上的相关文章 <a href="http://blog.nosqlfan.com/tags/MongoDB" target="_blank" rel="noopener">http://blog.nosqlfan.com/tags/MongoDB</a></p>
<h2 id="1、架设"><a href="#1、架设" class="headerlink" title="1、架设"></a>1、架设</h2><p>我们首先需要3台mongodb服务器，（除去仲裁服务器，最好是4台，之后会说明，这里我是用了mongodb v2.0版本），作为最基本的mongodb副本集搭建基础，还要保证这3台服务器网络互通。</p>
<p>a\启动</p>
<p>首先我们分别启动3台mongodb，命令如下：</p>
<p>四台mongodb服务器的ip分别为：10.1.10.31,  10.1.10.28,  10.1.10.30, 10.1.49.225(仲裁服务器)</p>
<p>mongod –replSet wzh –rest –dbpath /usr/local/wzhdb/ –journal –port 10001</p>
<p>简单说明一下：</p>
<p>–replSet wzh：表示副本集的名字为“wzh”，这里的名字可以任意取；</p>
<p>–rest：是打开web监控页面，比如我们这里监听10001端口，则打开<a href="http://10.1.49.225:11001/就可以看到这个mongodb数据库进程的信息" target="_blank" rel="noopener">http://10.1.49.225:11001/就可以看到这个mongodb数据库进程的信息</a></p>
<p>–journal：打开日志，我们这里模拟生产环境，所以建议将日志打开，以防不测。日志将会记录在/usr/local/wzhdb/journal/下，也就是你的数据库目录下（仲裁服务器不存储数据，不用打开此选项）</p>
<p>另外：这里没有使用后台运行，为了便于查看连接，我尽量模拟生产环境。</p>
<p>b\初始化</p>
<p>我们现在暂时将10.1.10.28作为master，于是我们用mongo命令登录10.1.10.28，来初始化副本集。</p>
<p>有3种方式可以初始化一个副本集：</p>
<p>1、db.runCommand( { replSetInitiate : &lt;config_object&gt; } )</p>
<p>2、rs.initiate(&lt;config_object&gt;)</p>
<p>3、rs.initiate()//先初始化，再通过rs.add等方法修改</p>
<p>这里的config_object会记录在local.system.replset这个集合内，这个集合会自动的在副本集成员之间广播，而且我们不能直接修改他们，需要使用命令来改变它，例如（replSetInitiate 命令）。</p>
<p>我们来看下config_object可以包括那些东西，下面是一个config对象的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  _id : &lt;setname&gt;,</span><br><span class="line">  members: [</span><br><span class="line">    &#123;</span><br><span class="line">      _id : &lt;ordinal&gt;,</span><br><span class="line">      host : &lt;hostname[:port]&gt;</span><br><span class="line">      [, arbiterOnly : true]</span><br><span class="line">      [, buildIndexes : &lt;bool&gt;]</span><br><span class="line">      [, hidden : true]</span><br><span class="line">      [, priority: &lt;priority&gt;]</span><br><span class="line">      [, tags: &#123;loc1 : desc1, loc2 : desc2, ..., locN : descN&#125;]</span><br><span class="line">      [, slaveDelay : &lt;n&gt;]</span><br><span class="line">      [, votes : &lt;n&gt;]</span><br><span class="line">    &#125;</span><br><span class="line">    , ...</span><br><span class="line">  ],</span><br><span class="line">  [settings: &#123;</span><br><span class="line">    [getLastErrorDefaults: &lt;lasterrdefaults&gt;]</span><br><span class="line">    [, getLastErrorModes : &lt;modes&gt;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详细说明：（默认值在括号中）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">_id：副本集的名字，必须和命令行的名字匹配，也就是您刚才启动mongodb数据库命令行的那个名字，数字字母，不能包含&quot;/&quot;;</span><br><span class="line">members：一个数组用来表示副本集中的每个成员，这个数组必须包含_id和host这2个key。</span><br><span class="line"></span><br><span class="line">members 数组：</span><br><span class="line">_id：在副本集中的每一个成员都必须有一个_id表示，这个_id是通常是数字，从0开始增长。需要注意的是当其中一个成员退休了（指从副本集config中移除了），新加入的成员不能重新使用这个退休成员的_id；</span><br><span class="line">host：ip地址和端口号；</span><br><span class="line">arbiterOnly（false）：如果是true，则表示这个成员为仲裁节点，不接收数据；</span><br><span class="line">buildIndexes（true）：如果设置为false，则会阻止在这个节点上创建第二索引，通常这个节点是作为纯粹的数据备份，从不用来被查询。不过也因为此节点没有第二索引，所以他写入的东西很少，也就需要很少的内存和磁盘。_id的索引还是会被创建的。只有当priority属性设置为0时，此项才能设置为false，一般不会用到这个选项；</span><br><span class="line">hidden（false）：如果此项为true，不要告诉客户端的此节点的存在，设置隐藏节点的原因是此节点的数据的使用模式和其他节点大为不同，比如：报表，统计，备份等。设置为ture时，允许你针对这个节点发送非主要查询。</span><br><span class="line">priority（1.0）：权重，更高的权重会被选举为主节点</span><br><span class="line">tags（｛｝）：一个文档代表这台服务器的位置，有利于位置感知的读写。其实就是表示此节点位于哪个数据中心的，mongodb会根据tags找近的数据中心节点同步数据。</span><br><span class="line">slaveDelay（0）：同步数据的延迟，设置为0表示立即更新同步数据。</span><br><span class="line">votes（1）：此节点可以发出的投票数，一般不用修改他</span><br><span class="line"></span><br><span class="line">settings 对象：settings对象可以在集群建立起来以后用再进行设置，通常使用默认值</span><br></pre></td></tr></table></figure>
<p>接下来我们来介绍下rs命令：在命令行我们输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rs.help()</span><br><span class="line"></span><br><span class="line">rs.status()                     &#123; replSetGetStatus : 1 &#125; checks repl set status</span><br><span class="line">rs.initiate()                   &#123; replSetInitiate : null &#125; initiates set with default settings</span><br><span class="line">rs.initiate(cfg)                &#123; replSetInitiate : cfg &#125; initiates set with configuration cfg</span><br><span class="line">rs.conf()                       get the current configuration object from local.system.replset</span><br><span class="line">rs.reconfig(cfg)                updates the configuration of a running replica set with cfg (disconnects)</span><br><span class="line">rs.add(hostportstr)             add a new member to the set with default attributes (disconnects)</span><br><span class="line">rs.add(membercfgobj)            add a new member to the set with extra attributes (disconnects)</span><br><span class="line">rs.addArb(hostportstr)          add a new member which is arbiterOnly:true (disconnects)</span><br><span class="line">rs.stepDown([secs])             step down as primary (momentarily) (disconnects)</span><br><span class="line">rs.freeze(secs)                 make a node ineligible to become primary for the time specified</span><br><span class="line">rs.remove(hostportstr)          remove a host from the replica set (disconnects)</span><br><span class="line">rs.slaveOk()                    shorthand for db.getMongo().setSlaveOk()</span><br><span class="line"></span><br><span class="line">db.isMaster()                   check who is primary</span><br></pre></td></tr></table></figure>
<p>命令就不翻译 了，我们现在建立一份配置文件，然后启动它，启动我们的mongodb副本集：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vavar conf = &#123;</span><br><span class="line">  _id : &quot;wzh&quot;,</span><br><span class="line">  members: [</span><br><span class="line">    &#123;</span><br><span class="line">      _id : 0,</span><br><span class="line">      host : &quot;10.1.10.28:10001&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      _id : 1,</span><br><span class="line">       host : &quot;10.1.10.30:10001&quot;   </span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      _id : 2,</span><br><span class="line">       host : &quot;10.1.10.31:10001&quot;   </span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      _id : 3,</span><br><span class="line">      host : &quot;10.1.49.225:10001&quot;,</span><br><span class="line">      arbiterOnly:true  </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;;rs.initiate(conf);</span><br></pre></td></tr></table></figure>
<p>执行后出现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;info&quot; : &quot;Config now saved locally.  Should come online in about a minute.&quot;,</span><br><span class="line">        &quot;ok&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>等1分钟整个副本集就正常启动起来了。</p>
<p>我们打开后台的副本集控制台看下：</p>
<p><img src="/img/mgo/m1.gif" alt="img"></p>
<p>28是主，30和31是从，而我的虚拟机225则作为仲裁服务器在这个副本集中。</p>
<h2 id="2、测试副本集同步"><a href="#2、测试副本集同步" class="headerlink" title="2、测试副本集同步"></a>2、测试副本集同步</h2><p>我们的副本集已经正常启动起来了，我们来测试一下副本集启动的情况吧，我们直接连上28，发现命令控制行的前缀变成 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY&gt;</span><br><span class="line">var tags = [&quot;abc&quot;,&quot;bcd&quot;,&quot;efg&quot;,&quot;fgh&quot;,&quot;ooo&quot;,&quot;jjj&quot;,&quot;kkk&quot;,&quot;lll&quot;,&quot;mmm&quot;];</span><br><span class="line">for(var i=0;i&lt;100000;i++)&#123;</span><br><span class="line"> db.test.insert(&#123;&quot;name&quot;:&quot;groupa&quot;,&quot;tags&quot;:tags&#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们往test集合里插入了10W条数据，为什么要带tags的key呢，我是为了另外一个篇文章所用的，利用mongodb做分词检索<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY&gt; db.test.find();  //0.25GB的数据</span><br><span class="line">PRIMARY&gt; db.test.count() //100000</span><br></pre></td></tr></table></figure></p>
<p>主服务器的10W条记录已经成功插入了，我们看下另外2台secondary的节点</p>
<p>分别连上30和31服务器</p>
<p>运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SECONDARY&gt; db.getMongo().setSlaveOk();</span><br><span class="line">SECONDARY&gt; db.test.count()//100000</span><br></pre></td></tr></table></figure></p>
<p>发现数据已经完全同步过来了</p>
<h2 id="3、删除和增加"><a href="#3、删除和增加" class="headerlink" title="3、删除和增加"></a>3、删除和增加</h2><p>如果相对副本集进行扩容，想加入一台mongodb服务器进入副本集，我们首先需要启动这个节点，最好是将数据事先拷贝一份启动，不然一个新的空的数据库进来同步可能会复制过多的数据而导致应用奔溃。</p>
<p>我们登录28服务器，先将30服务器去掉。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY&gt; rs.remove(&quot;10.1.10.30:10001&quot;);</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/mgo/m2.gif" alt="img"></p>
<p>观察副本集的状态，发现只剩下3台了，于是我们再往28服务器插入1000条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var tags = [&quot;nn&quot;,&quot;nn&quot;,&quot;vv&quot;,&quot;yy&quot;,&quot;ii&quot;,&quot;kk&quot;,&quot;gg&quot;,&quot;ee&quot;,&quot;aa&quot;];</span><br><span class="line">for(var i=0;i&lt;1000;i++)&#123;</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;groupa&quot;,&quot;tags&quot;:tags&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1000条数据是瞬间插入完成的。这样28和剩下的31服务器上就有了10W1000条数据了。</p>
<p>接下来我们把30服务器加回去，登录28服务器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY&gt; rs.add(&#123;_id:4,host:&quot;10.1.10.30:10001&quot;&#125;);</span><br><span class="line">&#123; &quot;ok&quot; : 1 &#125;</span><br></pre></td></tr></table></figure></p>
<p>将30服务器加回去，启动30上的mongodb；我们看下新加的1000条数据有没有同步过去了。登录30服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SECONDARY&gt; SECONDARY&gt; db.getMongo().setSlaveOk();</span><br><span class="line">SECONDARY&gt; db.test.count();</span><br><span class="line">101000</span><br></pre></td></tr></table></figure></p>
<p>就是这么简单，新加入的节点已经可以同步数据和正常工作了。</p>
<h2 id="2、容灾"><a href="#2、容灾" class="headerlink" title="2、容灾"></a>2、容灾</h2><p>1、单个节点意外崩溃</p>
<p>现在副本集中28是主，30和31是从，所以我手动将28的mongodb进程kill掉，看看整个集群是否还可以正常运作。</p>
<p>大约几秒钟，mongodb仲裁服务器选举出了一位新主人：</p>
<p><img src="/img/mgo/m3.gif" alt="img"></p>
<p>然后我们往新的主节点30插入1000条数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PRIMARY&gt; </span><br><span class="line">PRIMARY&gt; var tags = [&quot;nn&quot;,&quot;nn&quot;,&quot;vv&quot;,&quot;yy&quot;,&quot;ii&quot;,&quot;kk&quot;,&quot;gg&quot;,&quot;ee&quot;,&quot;aa&quot;];for(var i=0;i&lt;1000;i++)&#123;</span><br><span class="line">... db.test.insert(&#123;&quot;name&quot;:&quot;groupa&quot;,&quot;tags&quot;:tags&#125;)</span><br><span class="line">... &#125;</span><br><span class="line">PRIMARY&gt; </span><br><span class="line">PRIMARY&gt; db.test.count()</span><br><span class="line">102000</span><br></pre></td></tr></table></figure></p>
<p>现在我们一共10W2000条数据了，很快模拟故障修复了，我们正常启动28节点了，很明显30节点当老大很爽，不愿意将老大的位置再让回给28了：</p>
<p><img src="/img/mgo/m4.gif" alt="img"></p>
<p> 经过查询，发现28节点的数据也已经是10W2千条了，在28down的过程中，新增加的1000条数据已经同步过去拉。</p>
<p>2、同时意外崩溃2个节点</p>
<p>我们现在同时将副本集内的2个节点kill掉，模拟一个比较大的灾难。</p>
<p><img src="/img/mgo/m5.gif" alt="img"></p>
<p>上图可以看到只剩下31一台节点苦苦支撑了，另外2个兄弟已经down了，这时副本集中可用的数据节点只有1个了，仲裁服务器无数据的，所以自动降级为secondary，这时整个集群只可读，不可写。我们尝试往31数据库插入一些数据.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECONDARY&gt; var tags = [&quot;nn&quot;,&quot;nn&quot;,&quot;vv&quot;,&quot;yy&quot;,&quot;ii&quot;,&quot;kk&quot;,&quot;gg&quot;,&quot;ee&quot;,&quot;aa&quot;];for(var i=0;i&lt;1000;i++)&#123;</span><br><span class="line">... db.test.insert(&#123;&quot;name&quot;:&quot;groupa&quot;,&quot;tags&quot;:tags&#125;)</span><br><span class="line">... &#125;</span><br><span class="line">not master</span><br></pre></td></tr></table></figure></p>
<p>曝出了不是master的错误，之前在secondary上也是无法进行写操作的。之后修复问题或者网络，重新启动28和31的进程，就又能回复正常了。</p>
<p>3、衰到家了，其中一台硬盘数据损坏</p>
<p>我们现在模拟硬盘数据丢失的情况，比如我们的应用已经跑了一段时间了，突然30节点down机了，发现硬盘数据损坏了，我们的mongodb数据也全部丢失了，幸好我们当时建立了集群有其他兄弟备份着。</p>
<p>我们对30节点换了一块新硬盘，装好了系统以后准备加入这个集群，但是，且慢！</p>
<p>我们可以让集群中的一台服务器比如31，先脱离集群，然后将数据文件拷贝到30上，然后将30和31再加入集群，这样就不至于数据相差太大，同步过久导致整个应用缓慢或者崩溃。</p>
<p>这里就需要我们对副本集设置4台机器了，1台崩溃了，1台去修复了，还有2台正好1主1从抗住应用。所以如果只有3台的话，当副本集只剩下1台节点会进入secondary，就无法写入操作了，无法正常运行应用了。</p>
<p>总结一下具体步骤：</p>
<p>1、将副本集中的某一台机器A脱离副本集</p>
<p>2、将这台A机器的数据库文件夹copy到新安装的B机器上，或者启动mongodb副本集让这2台机器慢慢的同步，这样脱离应用的副本集同步不会拖慢整个副本集</p>
<p>3、同步完成以后分别将A和B机器加入到原来的副本集中即可。</p>
<p>3、客户端代码连入mongodb副本集</p>
<p>mongodb副本集主要是为了容灾备份和负载均衡用的。我们一般的互联网应用大多是读多写少，所以mongodb副本集只有一个主，而有多个从。那我们的客户端代码如何正确的连入mongodb副本集呢？下面我就以node.js利用rrestjs框架 和 node-mongodb-native 模块进行mongodb副本集的操作。</p>
<p>rrestjs框架官网：<a href="http://www.rrestjs.com/" target="_blank" rel="noopener">http://www.rrestjs.com/</a></p>
<p>官方帮助文档地址：<a href="https://github.com/christkv/node-mongodb-native/blob/master/docs/replicaset.md" target="_blank" rel="noopener">https://github.com/christkv/node-mongodb-native/blob/master/docs/replicaset.md</a></p>
<p>只需要将rrestjs的配置文件按如下配置即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MongodbRC:&apos;wzh&apos;,//如果是false表示不使用mongodb的副本集，否则为字符串，表示副本集的名称</span><br><span class="line">MongodbRChost:[&apos;10.1.10.28:10001&apos;,&apos;10.1.10.30:10001&apos;,&apos;10.1.10.31:10001&apos;],//表示mongodb副本集的ip:port数组。</span><br></pre></td></tr></table></figure></p>
<p>然后正常使用您的应用，插入查询等操作，rrestjs自动会帮你连入mongodb副本集了</p>
<p><img src="/img/mgo/m6.gif" alt="img"></p>
<p>成功的插入了mongodb副本集数据并返回了刚才插入的内容。</p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mongodb/" rel="tag"># mongodb</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2012/05/15/js-ajax/" rel="next" title="Mongodb技巧（部分摘自深入学习mongodb，持续更新）">
                <i class="fa fa-chevron-left"></i> Mongodb技巧（部分摘自深入学习mongodb，持续更新）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2012/06/07/js-ajax/" rel="prev" title="rrestjs v0.7.0 版本">
                rrestjs v0.7.0 版本 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">snoopyxdy</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">284</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、架设"><span class="nav-number">1.</span> <span class="nav-text">1、架设</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、测试副本集同步"><span class="nav-number">2.</span> <span class="nav-text">2、测试副本集同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、删除和增加"><span class="nav-number">3.</span> <span class="nav-text">3、删除和增加</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、容灾"><span class="nav-number">4.</span> <span class="nav-text">2、容灾</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">snoopyxdy</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.5.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="http://wzhfile.static.xytang88.com/gitmint.browser.js?v=2"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname,
            owner: 'DoubleSpout',
            repo: 'dsblog',
            
            lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '202e5bcda8eacf79e44b6261326de2e79eff846e',
            
                client_id: '7d56dc5e01e83a1a44bb'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    






  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
